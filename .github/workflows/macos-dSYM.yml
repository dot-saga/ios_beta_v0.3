name: macOS dSYM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: List schemes (workspace)
        run: |
          xcodebuild -list -workspace Meshtastic.xcworkspace || true
          if [ ! -f "Meshtastic.xcodeproj/xcshareddata/xcschemes/Meshtastic.xcscheme" ] && \
             [ ! -f "Meshtastic.xcworkspace/xcshareddata/xcschemes/Meshtastic.xcscheme" ]; then
            echo "::error::Shared scheme 'Meshtastic' not found. Open Xcode → Manage Schemes → check 'Shared' and commit the .xcscheme file."
            exit 1
          fi

      - name: Install xcpretty
        run: sudo gem install xcpretty --no-document

      - name: Build (Simulator, no code signing)
        run: |
          set -o pipefail
          xcodebuild \
            -workspace Meshtastic.xcworkspace \
            -scheme Meshtastic \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            CODE_SIGNING_ALLOWED=NO \
            build | xcpretty -c

      - name: Zip dSYM artifacts (if any)
        run: |
          mkdir -p artifacts
          dsym_count=$(find ~/Library/Developer/Xcode/DerivedData -name "*.dSYM" | wc -l | tr -d ' ')
          if [ "$dsym_count" -gt 0 ]; then
            find ~/Library/Developer/Xcode/DerivedData -name "*.dSYM" -print0 | xargs -0 zip -r artifacts/dsym-files.zip
          else
            echo "No dSYM files found."
          fi

      - name: Upload dSYM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dsym-files
          path: artifacts/dsym-files.zip
          if-no-files-found: ignore
